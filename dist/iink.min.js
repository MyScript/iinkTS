!function(i,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((i="undefined"!=typeof globalThis?globalThis:i||self).iink={})}(this,(function(i){"use strict";function __awaiter(i,n,s,a){return new(s||(s=Promise))((function(d,c){function fulfilled(i){try{step(a.next(i))}catch(i){c(i)}}function rejected(i){try{step(a.throw(i))}catch(i){c(i)}}function step(i){i.done?d(i.value):function adopt(i){return i instanceof s?i:new s((function(n){n(i)}))}(i.value).then(fulfilled,rejected)}step((a=a.apply(i,n||[])).next())}))}const n="Application credentials are invalid. Please check or regenerate your application key and hmackey.",s="An unknown error has occurred.",a="MyScript recognition server is not reachable. Please reload once you are connected.",d="Unable to establish a connection to MyScript recognition server. Check the host and your connectivity.",c="MyScript recognition server is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.",h="MyScript recognition server terminated the connection due to a protocol error.",l="MyScript recognition server terminated the connection because the endpoint received data of a type it cannot accept. (For example, a text-only endpoint received binary data.)",p="MyScript recognition server terminated the connection because a message was received that contained inconsistent data (e.g., non-UTF-8 data within a text message).",u="MyScript recognition server terminated the connection because it received a message that violates its policy.",g="MyScript recognition server terminated the connection because a data frame was received that is too large.",m="MyScript recognition server terminated the connection because it encountered an unexpected condition that prevented it from fulfilling the request.",v="MyScript recognition server terminated the connection because it is restarting.",f="MyScript recognition server terminated the connection due to a temporary condition, e.g. it is overloaded and is casting off some of its clients.",y="MyScript recognition server was acting as a gateway or proxy and received an invalid response from the upstream server.",x="MyScript recognition server connection was closed due to a failure to perform a TLS handshake",w="idle",b="changed",S="exported",C="loaded",k="clear",_="cleared",M="import",E="convert",P="error",T="ws_part_change",L="ws_content_change",A="ws_svg_patch",D="ws_exported",z="ws_error",I="ws_initialized",N="ws_connected",R="connection_active",O="ws_disconnected",W="CLOSE_RECOGNIZER";class PointerEventGrabber{constructor(i){this.prevent=i=>i.preventDefault(),this.pointerDownHandler=i=>{if(0===i.button&&1===i.buttons&&(this.activePointerId=i.pointerId,this.onPointerDown)){const n=this.extractPoint(i);this.onPointerDown(i,n)}},this.pointerMoveHandler=i=>{if(null!=this.activePointerId&&this.activePointerId===i.pointerId&&this.onPointerMove){const n=this.extractPoint(i);this.onPointerMove(i,n)}},this.pointerUpHandler=i=>{if(null!=this.activePointerId&&this.activePointerId===i.pointerId&&(this.activePointerId=void 0,i.stopPropagation(),this.onPointerUp)){const n=this.extractPoint(i);this.onPointerUp(i,n)}},this.setConfiguration(i)}roundFloat(i,n){if(n>=0){const s=Math.pow(10,n);return Math.round(i/s)*s}return i}extractPoint(i){let n,s;({clientX:n,clientY:s}="changedTouches"in i?i.changedTouches[0]:i);const a=this.domElement.getBoundingClientRect();return{x:this.roundFloat(n-a.left-this.domElement.clientLeft,this.configuration.xyFloatPrecision),y:this.roundFloat(s-a.top-this.domElement.clientTop,this.configuration.xyFloatPrecision),t:this.roundFloat(Date.now(),this.configuration.timestampFloatPrecision),p:i.pressure||1}}setConfiguration(i){this.configuration=i}attach(i){this.domElement&&this.detach(),this.domElement=i,this.domElement.addEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerout",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.addEventListener("touchmove",this.prevent),document.documentElement.addEventListener("pointerdown",(()=>{}))}detach(){this.domElement.removeEventListener("pointerdown",this.pointerDownHandler,this.configuration.listenerOptions),this.domElement.removeEventListener("pointermove",this.pointerMoveHandler,this.configuration.listenerOptions),this.domElement.removeEventListener("pointerup",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.removeEventListener("pointerout",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.removeEventListener("pointerleave",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.removeEventListener("pointercancel",this.pointerUpHandler,this.configuration.listenerOptions),this.domElement.removeEventListener("touchmove",this.prevent),document.documentElement.removeEventListener("pointerdown",(()=>{}))}}const j={table:"table",shape:"shape",recognizedShape:"recognizedShape",ellipse:"ellipse",line:"line"};function phi(i){let n=(i+Math.PI)%(2*Math.PI)-Math.PI;return n<-Math.PI&&(n+=2*Math.PI),n}function drawArrowHead(i,n,s,a){const d=phi(s+Math.PI*(7/8)),c=phi(s-Math.PI*(7/8));i.save();try{i.fillStyle=i.strokeStyle,i.moveTo(n.x,n.y),i.beginPath(),i.lineTo(n.x+a*Math.cos(d),n.y+a*Math.sin(d)),i.lineTo(n.x+a*Math.cos(c),n.y+a*Math.sin(c)),i.lineTo(n.x,n.y),i.fill()}finally{i.restore()}}function drawShapeEllipse(i,n){const s=function drawEllipseArc(i,n){const{centerPoint:s,maxRadius:a,minRadius:d,orientation:c,startAngle:h,sweepAngle:l}=n;let p=Math.cos(c),u=Math.sin(c),g=p,m=u;p*=a,g*=d,u*=a,m*=d;const v=Math.floor(Math.abs(l)/.02),f=[];i.save();try{i.beginPath();for(let n=0;n<=v;n++){const c=h+n/v*l,y=Math.atan2(Math.sin(c)/d,Math.cos(c)/a),x=Math.cos(y),w=Math.sin(y),b=s.x+p*x-m*w,S=s.y+g*w+u*x;0===n?i.moveTo(b,S):i.lineTo(b,S),0!==n&&n!==v||f.push({x:b,y:S})}i.stroke()}finally{i.restore()}return f}(i,n);"ARROW_HEAD"===(null==n?void 0:n.beginDecoration)&&drawArrowHead(i,s[0],n.beginTangentAngle,12),"ARROW_HEAD"===(null==n?void 0:n.endDecoration)&&drawArrowHead(i,s[1],n.endTangentAngle,12)}function drawLine(i,n,s){i.save();try{i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(s.x,s.y),i.stroke()}finally{i.restore()}}function drawShapeSymbol(i,n){i.save();try{if(i.lineWidth=n.width,i.strokeStyle=n.color,n.elementType)switch(n.elementType){case j.shape:const s=n;drawShapeSymbol(i,s.candidates[s.selectedCandidateIndex]);break;case j.table:n.lines.forEach((n=>drawShapeSymbol(i,n)));break;case j.line:const a=n;drawLine(i,a.data.p1,a.data.p2)}else switch(n.type){case j.ellipse:drawShapeEllipse(i,n);break;case j.line:!function drawShapeLine(i,n){drawLine(i,n.firstPoint,n.lastPoint),"ARROW_HEAD"===n.beginDecoration&&drawArrowHead(i,n.firstPoint,n.beginTangentAngle,12),"ARROW_HEAD"===n.endDecoration&&drawArrowHead(i,n.lastPoint,n.endTangentAngle,12)}(i,n);break;case j.recognizedShape:n.primitives.forEach((n=>drawShapeSymbol(i,n)))}}finally{i.restore()}}const H={inputCharacter:"inputCharacter",char:"char",string:"string",textLine:"textLine"};function drawTextLine(i,n){!function drawText(i,n,s){i.save();try{i.font=`${s.textHeight}px serif`,i.textAlign="CENTER"===s.justificationType?"center":"left",i.textBaseline="bottom",i.fillStyle=i.strokeStyle,i.fillText(n,s.topLeftPoint.x,s.topLeftPoint.y+s.height)}finally{i.restore()}}(i,n.label,n.data),n.underlineList.forEach((s=>{!function drawUnderline(i,n,s,a){const d=a.width/s.length;drawLine(i,{x:a.topLeftPoint.x+n.data.firstCharacter*d,y:a.topLeftPoint.y+a.height},{x:a.topLeftPoint.x+n.data.lastCharacter*d,y:a.topLeftPoint.y+a.height})}(i,s,n.label,n.data)}))}function computeLinksPoints(i,n,s){const a=i.p*s;return[{x:i.x-Math.sin(n)*a,y:i.y+Math.cos(n)*a},{x:i.x+Math.sin(n)*a,y:i.y-Math.cos(n)*a}]}function computeMiddlePoint(i,n){return{x:(n.x+i.x)/2,y:(n.y+i.y)/2,p:(n.p+i.p)/2,t:(n.t+i.t)/2}}function computeAxeAngle(i,n){return Math.atan2(n.y-i.y,n.x-i.x)}class CanvasQuadraticStroker{renderArc(i,n,s){i.arc(n.x,n.y,s,0,2*Math.PI,!0)}renderLine(i,n,s,a){const d=computeLinksPoints(n,computeAxeAngle(n,s),a),c=computeLinksPoints(s,computeAxeAngle(n,s),a);i.moveTo(d[0].x,d[0].y),i.lineTo(c[0].x,c[0].y),i.lineTo(c[1].x,c[1].y),i.lineTo(d[1].x,d[1].y)}renderFinal(i,n,s,a){const d=computeAxeAngle(n,s),c=computeLinksPoints(s,d,a);i.moveTo(c[0].x,c[0].y);for(let n=1;n<=6;n++){const c=d-n*Math.PI/6;i.lineTo(s.x-s.p*a*Math.sin(c),s.y+s.p*a*Math.cos(c))}}renderQuadratic(i,n,s,a,d){const c=computeLinksPoints(n,computeAxeAngle(n,a),d),h=computeLinksPoints(s,computeAxeAngle(a,s),d),l=computeLinksPoints(a,computeAxeAngle(n,s),d);i.moveTo(c[0].x,c[0].y),i.quadraticCurveTo(l[0].x,l[0].y,h[0].x,h[0].y),i.lineTo(h[1].x,h[1].y),i.quadraticCurveTo(l[1].x,l[1].y,c[1].x,c[1].y)}getPointByIndex(i,n){return{x:i.x[n]||0,y:i.y[n]||0,t:i.t[n]||0,p:i.p[n]||0}}drawStroke(i,n){const s=n.x.length,a=n.width>0?n.width:i.lineWidth,d=n.color?n.color:i.strokeStyle,c=this.getPointByIndex(n,0),h=s-2;i.save();try{if(i.beginPath(),s<3)this.renderArc(i,c,.6*a);else{this.renderArc(i,c,a*c.p);const d=computeMiddlePoint(c,this.getPointByIndex(n,1));this.renderLine(i,c,d,a);for(let s=0;s<h;s++){const d=computeMiddlePoint(this.getPointByIndex(n,s),this.getPointByIndex(n,s+1)),c=computeMiddlePoint(this.getPointByIndex(n,s+1),this.getPointByIndex(n,s+2)),h=this.getPointByIndex(n,s+1);this.renderQuadratic(i,d,c,h,a)}const l=computeMiddlePoint(this.getPointByIndex(n,s-2),this.getPointByIndex(n,s-1)),p=this.getPointByIndex(n,s-1);this.renderLine(i,l,p,a);const u=this.getPointByIndex(n,s-2),g=this.getPointByIndex(n,s-1);this.renderFinal(i,u,g,a)}i.closePath(),void 0!==d&&(i.fillStyle=d,i.fill()),i.save()}finally{i.restore()}}}class CanvasRenderer{constructor(i){this.config=i,this.stroker=new CanvasQuadraticStroker}createCanvas(i,n){const s=document.createElement("canvas");return s.id=n,s.classList.add(n),s.classList.add("ms-canvas"),i.appendChild(s),s}resizeContent(){const i=window.devicePixelRatio;[this.context.renderingCanvas,this.context.capturingCanvas].forEach((n=>{var s;const a=n.parentNode,d=Math.max(this.config.minWidth,a.clientWidth),c=Math.max(this.config.minHeight,a.clientHeight);n.width=d*i,n.height=c*i,null===(s=n.getContext("2d"))||void 0===s||s.scale(i,i),n.style.width=`${d}px`,n.style.height=`${c}px`}))}drawSymbol(i,n){const s=n.elementType||n.type;"stroke"===s?function drawStroke(i,n,s){s&&n&&"eraser"!==n.pointerType&&s.drawStroke(i,n)}(i,n,this.stroker):Object.keys(H).includes(s)?function drawTextSymbol(i,n){i.save();try{i.lineWidth=n.width,i.strokeStyle=n.color,(n.elementType||n.type)===H.textLine&&drawTextLine(i,n)}finally{i.restore()}}(i,n):Object.keys(j).includes(s)&&drawShapeSymbol(i,n)}init(i){const n=this.createCanvas(i,"ms-rendering-canvas"),s=this.createCanvas(i,"ms-capture-canvas");this.context={parent:i,renderingCanvas:n,renderingCanvasContext:n.getContext("2d"),capturingCanvas:s,capturingCanvasContext:s.getContext("2d")},this.resizeContent()}drawModel(i){var n;null===(n=this.context.renderingCanvasContext)||void 0===n||n.clearRect(0,0,this.context.renderingCanvas.width,this.context.renderingCanvas.height);const s=[...i.defaultSymbols,...i.rawStrokes];s.forEach((i=>this.drawSymbol(this.context.renderingCanvasContext,i))),this.context.capturingCanvasContext.clearRect(0,0,this.context.capturingCanvas.width,this.context.capturingCanvas.height),i.updatePositionRendered(s.length)}drawPendingStroke(i){this.context.capturingCanvasContext.clearRect(0,0,this.context.capturingCanvas.width,this.context.capturingCanvas.height),i&&"eraser"!==(null==i?void 0:i.pointerType)&&this.stroker.drawStroke(this.context.capturingCanvasContext,i)}resize(i){this.resizeContent(),this.drawModel(i)}destroy(){for(;this.context.parent.lastChild;)this.context.parent.removeChild(this.context.parent.lastChild)}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function createCommonjsModule(i,n){return i(n={exports:{}},n.exports),n.exports}var B=createCommonjsModule((function(i,n){i.exports=function(i){function e(s){if(n[s])return n[s].exports;var a=n[s]={i:s,l:!1,exports:{}};return i[s].call(a.exports,a,a.exports,e),a.l=!0,a.exports}var n={};return e.m=i,e.c=n,e.i=function(i){return i},e.d=function(i,n,s){e.o(i,n)||Object.defineProperty(i,n,{configurable:!1,enumerable:!0,get:s})},e.n=function(i){var n=i&&i.__esModule?function(){return i.default}:function(){return i};return e.d(n,"a",n),n},e.o=function(i,n){return Object.prototype.hasOwnProperty.call(i,n)},e.p="",e(e.s=1)}([function(i,n,s){function o(i,n){if(!(i instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(i){return typeof i}:function(i){return i&&"function"==typeof Symbol&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i},d=function t(i){var n=this;o(this,t),this.toJSON=function(i){if("string"!=typeof i)return console.error("Need a CSS string but given ",void 0===i?"undefined":a(i),i),"Not a valid CSS..!";var s={},d=void 0,c=void 0,h=void 0;try{i.split("{").forEach((function(i){if(c=i.trim())if(-1===c.indexOf("}"))s[c]={},d=c;else{c.substring(0,c.indexOf("}")).split(";").forEach((function(i){(h=i.split(":"))&&2===h.length&&(s[d][h[0].trim().replace(/^\"|\"$/g,"")]=n._trimSemiColon(h[1].trim().replace(/^\"|\"$/g,"")))}));try{(d=c.split("}")[1].trim())&&(s[d]={})}catch(i){}}}))}catch(i){return"Not a valid CSS..!"}return s},this.toCSS=function(i){if("object"!==(void 0===i?"undefined":a(i)))return console.error("Need a JSON object but given ",void 0===i?"undefined":a(i),i),"Not a valid JSON..!";var n="";try{for(var s in i)if(i.hasOwnProperty(s)){for(var d in n+=s+" {\n",i[s])i[s].hasOwnProperty(d)&&(n+=d+": "+i[s][d]+";\n");n+="}\n"}}catch(i){return"Not a valid JSON..!"}return n},this._trimSemiColon=function(i){return";"===i.slice(-1)?i.slice(0,n.length-1):i}};n.default=d},function(i,n,s){i.exports=s(0).default}])})),X=function unwrapExports(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}(B);B.JsonCSS;const U=new X;var $={themeToCSS(i){let n=U.toCSS(i);return n=n.replace(/[\r\n]+/gm,""),n},themeToJSON(i){const n=U.toJSON(i);return n[".text"]["font-size"]=Number(n[".text"]["font-size"]),n.ink["-myscript-pen-width"]=Number(n.ink["-myscript-pen-width"]),n.ink.width=Number(n.ink.width),n},penStyleToCSS(i){let n=U.toCSS({css:i});return n=n.substring(6,n.length-3),n=n.replace(/[\r\n]+/gm,""),n},penStyleToJSON(i){const n=U.toJSON(`css {${i}}`).css;return n.width=Number(n.width),n["-myscript-pen-width"]=Number(n["-myscript-pen-width"]),n}},G=createCommonjsModule((function(i,n){var s;i.exports=(s=s||function(i,n){var s=Object.create||function(){function F(){}return function(i){var n;return F.prototype=i,n=new F,F.prototype=null,n}}(),a={},d=a.lib={},c=d.Base={extend:function(i){var n=s(this);return i&&n.mixIn(i),n.hasOwnProperty("init")&&this.init!==n.init||(n.init=function(){n.$super.init.apply(this,arguments)}),n.init.prototype=n,n.$super=this,n},create:function(){var i=this.extend();return i.init.apply(i,arguments),i},init:function(){},mixIn:function(i){for(var n in i)i.hasOwnProperty(n)&&(this[n]=i[n]);i.hasOwnProperty("toString")&&(this.toString=i.toString)},clone:function(){return this.init.prototype.extend(this)}},h=d.WordArray=c.extend({init:function(i,s){i=this.words=i||[],this.sigBytes=s!=n?s:4*i.length},toString:function(i){return(i||p).stringify(this)},concat:function(i){var n=this.words,s=i.words,a=this.sigBytes,d=i.sigBytes;if(this.clamp(),a%4)for(var c=0;c<d;c++){var h=s[c>>>2]>>>24-c%4*8&255;n[a+c>>>2]|=h<<24-(a+c)%4*8}else for(c=0;c<d;c+=4)n[a+c>>>2]=s[c>>>2];return this.sigBytes+=d,this},clamp:function(){var n=this.words,s=this.sigBytes;n[s>>>2]&=4294967295<<32-s%4*8,n.length=i.ceil(s/4)},clone:function(){var i=c.clone.call(this);return i.words=this.words.slice(0),i},random:function(n){for(var s,a=[],r=function(n){var s=987654321,a=4294967295;return function(){var d=((s=36969*(65535&s)+(s>>16)&a)<<16)+(n=18e3*(65535&n)+(n>>16)&a)&a;return d/=4294967296,(d+=.5)*(i.random()>.5?1:-1)}},d=0;d<n;d+=4){var c=r(4294967296*(s||i.random()));s=987654071*c(),a.push(4294967296*c()|0)}return new h.init(a,n)}}),l=a.enc={},p=l.Hex={stringify:function(i){for(var n=i.words,s=i.sigBytes,a=[],d=0;d<s;d++){var c=n[d>>>2]>>>24-d%4*8&255;a.push((c>>>4).toString(16)),a.push((15&c).toString(16))}return a.join("")},parse:function(i){for(var n=i.length,s=[],a=0;a<n;a+=2)s[a>>>3]|=parseInt(i.substr(a,2),16)<<24-a%8*4;return new h.init(s,n/2)}},u=l.Latin1={stringify:function(i){for(var n=i.words,s=i.sigBytes,a=[],d=0;d<s;d++){var c=n[d>>>2]>>>24-d%4*8&255;a.push(String.fromCharCode(c))}return a.join("")},parse:function(i){for(var n=i.length,s=[],a=0;a<n;a++)s[a>>>2]|=(255&i.charCodeAt(a))<<24-a%4*8;return new h.init(s,n)}},g=l.Utf8={stringify:function(i){try{return decodeURIComponent(escape(u.stringify(i)))}catch(i){throw new Error("Malformed UTF-8 data")}},parse:function(i){return u.parse(unescape(encodeURIComponent(i)))}},m=d.BufferedBlockAlgorithm=c.extend({reset:function(){this._data=new h.init,this._nDataBytes=0},_append:function(i){"string"==typeof i&&(i=g.parse(i)),this._data.concat(i),this._nDataBytes+=i.sigBytes},_process:function(n){var s=this._data,a=s.words,d=s.sigBytes,c=this.blockSize,l=d/(4*c),p=(l=n?i.ceil(l):i.max((0|l)-this._minBufferSize,0))*c,u=i.min(4*p,d);if(p){for(var g=0;g<p;g+=c)this._doProcessBlock(a,g);var m=a.splice(0,p);s.sigBytes-=u}return new h.init(m,u)},clone:function(){var i=c.clone.call(this);return i._data=this._data.clone(),i},_minBufferSize:0});d.Hasher=m.extend({cfg:c.extend(),init:function(i){this.cfg=this.cfg.extend(i),this.reset()},reset:function(){m.reset.call(this),this._doReset()},update:function(i){return this._append(i),this._process(),this},finalize:function(i){return i&&this._append(i),this._doFinalize()},blockSize:16,_createHelper:function(i){return function(n,s){return new i.init(s).finalize(n)}},_createHmacHelper:function(i){return function(n,s){return new v.HMAC.init(i,s).finalize(n)}}});var v=a.algo={};return a}(Math),s)})),J=createCommonjsModule((function(i,n){i.exports=G.enc.Hex})),V=(createCommonjsModule((function(i,n){var s,a,d,c,h,l,p;i.exports=(d=(a=p=G).lib,c=d.Base,h=d.WordArray,(l=a.x64={}).Word=c.extend({init:function(i,n){this.high=i,this.low=n}}),l.WordArray=c.extend({init:function(i,n){i=this.words=i||[],this.sigBytes=n!=s?n:8*i.length},toX32:function(){for(var i=this.words,n=i.length,s=[],a=0;a<n;a++){var d=i[a];s.push(d.high),s.push(d.low)}return h.create(s,this.sigBytes)},clone:function(){for(var i=c.clone.call(this),n=i.words=this.words.slice(0),s=n.length,a=0;a<s;a++)n[a]=n[a].clone();return i}}),p)})),createCommonjsModule((function(i,n){var s;i.exports=(s=G,function(){var i=s,n=i.lib.Hasher,a=i.x64,d=a.Word,c=a.WordArray,h=i.algo;function X64Word_create(){return d.create.apply(d,arguments)}var l=[X64Word_create(1116352408,3609767458),X64Word_create(1899447441,602891725),X64Word_create(3049323471,3964484399),X64Word_create(3921009573,2173295548),X64Word_create(961987163,4081628472),X64Word_create(1508970993,3053834265),X64Word_create(2453635748,2937671579),X64Word_create(2870763221,3664609560),X64Word_create(3624381080,2734883394),X64Word_create(310598401,1164996542),X64Word_create(607225278,1323610764),X64Word_create(1426881987,3590304994),X64Word_create(1925078388,4068182383),X64Word_create(2162078206,991336113),X64Word_create(2614888103,633803317),X64Word_create(3248222580,3479774868),X64Word_create(3835390401,2666613458),X64Word_create(4022224774,944711139),X64Word_create(264347078,2341262773),X64Word_create(604807628,2007800933),X64Word_create(770255983,1495990901),X64Word_create(1249150122,1856431235),X64Word_create(1555081692,3175218132),X64Word_create(1996064986,2198950837),X64Word_create(2554220882,3999719339),X64Word_create(2821834349,766784016),X64Word_create(2952996808,2566594879),X64Word_create(3210313671,3203337956),X64Word_create(3336571891,1034457026),X64Word_create(3584528711,2466948901),X64Word_create(113926993,3758326383),X64Word_create(338241895,168717936),X64Word_create(666307205,1188179964),X64Word_create(773529912,1546045734),X64Word_create(1294757372,1522805485),X64Word_create(1396182291,2643833823),X64Word_create(1695183700,2343527390),X64Word_create(1986661051,1014477480),X64Word_create(2177026350,1206759142),X64Word_create(2456956037,344077627),X64Word_create(2730485921,1290863460),X64Word_create(2820302411,3158454273),X64Word_create(3259730800,3505952657),X64Word_create(3345764771,106217008),X64Word_create(3516065817,3606008344),X64Word_create(3600352804,1432725776),X64Word_create(4094571909,1467031594),X64Word_create(275423344,851169720),X64Word_create(430227734,3100823752),X64Word_create(506948616,1363258195),X64Word_create(659060556,3750685593),X64Word_create(883997877,3785050280),X64Word_create(958139571,3318307427),X64Word_create(1322822218,3812723403),X64Word_create(1537002063,2003034995),X64Word_create(1747873779,3602036899),X64Word_create(1955562222,1575990012),X64Word_create(2024104815,1125592928),X64Word_create(2227730452,2716904306),X64Word_create(2361852424,442776044),X64Word_create(2428436474,593698344),X64Word_create(2756734187,3733110249),X64Word_create(3204031479,2999351573),X64Word_create(3329325298,3815920427),X64Word_create(3391569614,3928383900),X64Word_create(3515267271,566280711),X64Word_create(3940187606,3454069534),X64Word_create(4118630271,4000239992),X64Word_create(116418474,1914138554),X64Word_create(174292421,2731055270),X64Word_create(289380356,3203993006),X64Word_create(460393269,320620315),X64Word_create(685471733,587496836),X64Word_create(852142971,1086792851),X64Word_create(1017036298,365543100),X64Word_create(1126000580,2618297676),X64Word_create(1288033470,3409855158),X64Word_create(1501505948,4234509866),X64Word_create(1607167915,987167468),X64Word_create(1816402316,1246189591)],p=[];!function(){for(var i=0;i<80;i++)p[i]=X64Word_create()}();var u=h.SHA512=n.extend({_doReset:function(){this._hash=new c.init([new d.init(1779033703,4089235720),new d.init(3144134277,2227873595),new d.init(1013904242,4271175723),new d.init(2773480762,1595750129),new d.init(1359893119,2917565137),new d.init(2600822924,725511199),new d.init(528734635,4215389547),new d.init(1541459225,327033209)])},_doProcessBlock:function(i,n){for(var s=this._hash.words,a=s[0],d=s[1],c=s[2],h=s[3],u=s[4],g=s[5],m=s[6],v=s[7],f=a.high,y=a.low,x=d.high,w=d.low,b=c.high,S=c.low,C=h.high,k=h.low,_=u.high,M=u.low,E=g.high,P=g.low,T=m.high,L=m.low,A=v.high,D=v.low,z=f,I=y,N=x,R=w,O=b,W=S,j=C,H=k,B=_,X=M,U=E,$=P,G=T,J=L,V=A,q=D,Q=0;Q<80;Q++){var Y=p[Q];if(Q<16)var Z=Y.high=0|i[n+2*Q],K=Y.low=0|i[n+2*Q+1];else{var ee=p[Q-15],te=ee.high,ie=ee.low,ne=(te>>>1|ie<<31)^(te>>>8|ie<<24)^te>>>7,re=(ie>>>1|te<<31)^(ie>>>8|te<<24)^(ie>>>7|te<<25),oe=p[Q-2],se=oe.high,ae=oe.low,de=(se>>>19|ae<<13)^(se<<3|ae>>>29)^se>>>6,ce=(ae>>>19|se<<13)^(ae<<3|se>>>29)^(ae>>>6|se<<26),he=p[Q-7],le=he.high,pe=he.low,ue=p[Q-16],ge=ue.high,me=ue.low;Z=(Z=(Z=ne+le+((K=re+pe)>>>0<re>>>0?1:0))+de+((K+=ce)>>>0<ce>>>0?1:0))+ge+((K+=me)>>>0<me>>>0?1:0),Y.high=Z,Y.low=K}var ve,fe=B&U^~B&G,ye=X&$^~X&J,xe=z&N^z&O^N&O,we=I&R^I&W^R&W,be=(z>>>28|I<<4)^(z<<30|I>>>2)^(z<<25|I>>>7),Se=(I>>>28|z<<4)^(I<<30|z>>>2)^(I<<25|z>>>7),Ce=(B>>>14|X<<18)^(B>>>18|X<<14)^(B<<23|X>>>9),ke=(X>>>14|B<<18)^(X>>>18|B<<14)^(X<<23|B>>>9),_e=l[Q],Me=_e.high,Ee=_e.low,Pe=V+Ce+((ve=q+ke)>>>0<q>>>0?1:0),Te=Se+we;V=G,q=J,G=U,J=$,U=B,$=X,B=j+(Pe=(Pe=(Pe=Pe+fe+((ve+=ye)>>>0<ye>>>0?1:0))+Me+((ve+=Ee)>>>0<Ee>>>0?1:0))+Z+((ve+=K)>>>0<K>>>0?1:0))+((X=H+ve|0)>>>0<H>>>0?1:0)|0,j=O,H=W,O=N,W=R,N=z,R=I,z=Pe+(be+xe+(Te>>>0<Se>>>0?1:0))+((I=ve+Te|0)>>>0<ve>>>0?1:0)|0}y=a.low=y+I,a.high=f+z+(y>>>0<I>>>0?1:0),w=d.low=w+R,d.high=x+N+(w>>>0<R>>>0?1:0),S=c.low=S+W,c.high=b+O+(S>>>0<W>>>0?1:0),k=h.low=k+H,h.high=C+j+(k>>>0<H>>>0?1:0),M=u.low=M+X,u.high=_+B+(M>>>0<X>>>0?1:0),P=g.low=P+$,g.high=E+U+(P>>>0<$>>>0?1:0),L=m.low=L+J,m.high=T+G+(L>>>0<J>>>0?1:0),D=v.low=D+q,v.high=A+V+(D>>>0<q>>>0?1:0)},_doFinalize:function(){var i=this._data,n=i.words,s=8*this._nDataBytes,a=8*i.sigBytes;return n[a>>>5]|=128<<24-a%32,n[30+(a+128>>>10<<5)]=Math.floor(s/4294967296),n[31+(a+128>>>10<<5)]=s,i.sigBytes=4*n.length,this._process(),this._hash.toX32()},clone:function(){var i=n.clone.call(this);return i._hash=this._hash.clone(),i},blockSize:32});i.SHA512=n._createHelper(u),i.HmacSHA512=n._createHmacHelper(u)}(),s.SHA512)})),createCommonjsModule((function(i,n){var s,a,d;i.exports=(a=(s=G).lib.Base,d=s.enc.Utf8,void(s.algo.HMAC=a.extend({init:function(i,n){i=this._hasher=new i.init,"string"==typeof n&&(n=d.parse(n));var s=i.blockSize,a=4*s;n.sigBytes>a&&(n=i.finalize(n)),n.clamp();for(var c=this._oKey=n.clone(),h=this._iKey=n.clone(),l=c.words,p=h.words,u=0;u<s;u++)l[u]^=1549556828,p[u]^=909522486;c.sigBytes=h.sigBytes=a,this.reset()},reset:function(){var i=this._hasher;i.reset(),i.update(this._iKey)},update:function(i){return this._hasher.update(i),this},finalize:function(i){var n=this._hasher,s=n.finalize(i);return n.reset(),n.finalize(this._oKey.clone().concat(s))}})))})),createCommonjsModule((function(i,n){i.exports=G.HmacSHA512})));function computeHmac(i,n,s){return new V(i,n+s).toString(J)}class AbstractRecognizer{constructor(i,n){this.serverConfiguration=i,this.recognitionConfiguration=n}init(i,n){}}class RestRecognizer extends AbstractRecognizer{constructor(i,n){super(i,n)}get url(){return`${this.serverConfiguration.scheme}://${this.serverConfiguration.host}/api/v4.0/iink/batch`}get postConfig(){switch(this.recognitionConfiguration.type){case"DIAGRAM":return{lang:this.recognitionConfiguration.lang,diagram:this.recognitionConfiguration.diagram,export:this.recognitionConfiguration.export};case"MATH":return{lang:this.recognitionConfiguration.lang,math:this.recognitionConfiguration.math,export:this.recognitionConfiguration.export};case"Raw Content":return{lang:this.recognitionConfiguration.lang,"raw-content":this.recognitionConfiguration["raw-content"],export:this.recognitionConfiguration.export};case"TEXT":return{lang:this.recognitionConfiguration.lang,text:this.recognitionConfiguration.text,export:this.recognitionConfiguration.export};default:throw new Error(`get postConfig error Recognition type unkow "${this.recognitionConfiguration.type}"`)}}buildData(i){const n=[];i.strokeGroups.forEach((i=>{const s={penStyle:"{}"===JSON.stringify(i.penStyle)?void 0:$.penStyleToCSS(i.penStyle),strokes:i.strokes.map((i=>({x:i.x,y:i.y,t:i.t,p:i.p,pointerType:i.pointerType})))};n.push(s)}));const s="Raw Content"===this.recognitionConfiguration.type?"Raw Content":this.recognitionConfiguration.type.charAt(0).toUpperCase()+this.recognitionConfiguration.type.slice(1).toLowerCase();return{configuration:this.postConfig,xDPI:96,yDPI:96,contentType:s,height:i.height,width:i.width,strokeGroups:n}}post(i,n){return __awaiter(this,void 0,void 0,(function*(){const s=new Headers;s.append("Accept","application/json,"+n),s.append("applicationKey",this.serverConfiguration.applicationKey),s.append("hmac",computeHmac(JSON.stringify(i),this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey)),s.append("Content-Type","application/json");const a={method:"POST",headers:s,body:JSON.stringify(i)},d=new Request(this.url,a),c=yield fetch(d);if(c.ok){let i;switch(c.headers.get("content-type")){case"application/vnd.openxmlformats-officedocument.presentationml.presentation":case"image/png":case"image/jpeg":i=yield c.blob();break;case"application/json":i=yield c.json();break;case"application/vnd.myscript.jiix":i=yield c.clone().json().catch((()=>__awaiter(this,void 0,void 0,(function*(){return yield c.text()}))));break;default:i=yield c.text()}return i}throw yield c.json()}))}tryFetch(i,a){return __awaiter(this,void 0,void 0,(function*(){return this.post(i,a).then((i=>{const n={};return n[a]=i,n})).catch((i=>{let a=i.message||s;i.code?"access.not.granted"===i.code&&(a=n):a=d;throw new Error(a)}))}))}getMimeTypes(i){let n=i||[];if(!n.length)switch(this.recognitionConfiguration.type){case"DIAGRAM":n=this.recognitionConfiguration.diagram.mimeTypes;break;case"MATH":n=this.recognitionConfiguration.math.mimeTypes;break;case"Raw Content":n=["application/vnd.myscript.jiix"];break;case"TEXT":n=this.recognitionConfiguration.text.mimeTypes;break;default:throw new Error(`Recognition type "${this.recognitionConfiguration.type}" is unknown.\n Possible types are:\n -DIAGRAM\n -MATH\n -Raw Content\n -TEXT`)}return n}convert(i,n,s){return __awaiter(this,void 0,void 0,(function*(){const a=i.getClone();a.updatePositionSent();const d=this.getMimeTypes(s),c=this.buildData(a);c.conversionState=n;const h=d.map((i=>this.tryFetch(c,i)));return(yield Promise.all(h)).forEach((i=>{a.converts=Object.assign(a.converts||{},i)})),a.updatePositionReceived(),a}))}exportModel(i,n){return __awaiter(this,void 0,void 0,(function*(){const s=this.buildData(i);return this.tryFetch(s,n)}))}export(i,n){return __awaiter(this,void 0,void 0,(function*(){const s=i.getClone();if(s.updatePositionSent(),s.isEmpty)return Promise.resolve(s);const a=this.getMimeTypes(n);if(!a.length)return Promise.reject(new Error("Export failed, no mimeTypes define in recognition configuration"));const d=a.filter((i=>!s.exports||!s.exports[i]));return(yield Promise.all(d.map((i=>this.exportModel(s,i))))).forEach((i=>{s.exports=Object.assign(s.exports||{},i)})),s.updatePositionReceived(),s}))}resize(i){return __awaiter(this,void 0,void 0,(function*(){return this.export(i)}))}}class DeferredPromise{constructor(){this.isFullFilled=!1,this.isPending=!0,this.promise=new Promise(((i,n)=>{this.reject=i=>__awaiter(this,void 0,void 0,(function*(){return this.isFullFilled=!0,this.isPending=!1,n(i)})),this.resolve=n=>__awaiter(this,void 0,void 0,(function*(){return this.isFullFilled=!0,this.isPending=!1,i(n)}))}))}}class GlobalEvent extends EventTarget{constructor(){super()}static getInstance(){return GlobalEvent.instance||(GlobalEvent.instance=new GlobalEvent),GlobalEvent.instance}emit(i,n){this.dispatchEvent(new CustomEvent(i,Object.assign({bubbles:!0,composed:!0},n?{detail:n}:void 0)))}emitLoaded(){this.emit(C)}emitExported(i){this.emit(S,i)}emitChange(i){this.emit(b,{canUndo:i.canUndo,canRedo:i.canRedo,canClear:!i.stack[i.stackIndex].isEmpty,stackIndex:i.stackIndex,stackLength:i.stack.length,isEmpty:i.stack[i.stackIndex].isEmpty})}emitIdle(i){this.emit(w,i)}emitError(i){this.emit(P,i)}emitClear(i){this.emit(k,i)}emitCleared(i){this.emit(_,i)}emitConvert(i){this.emit(E,i)}emitImport(i,n){this.emit(M,{jiix:i,mimeType:n})}}class UndoRedoContext{constructor(i){this.stackIndex=0,this.stack=[i.getClone()],this.canRedo=!1,this.canUndo=!1}}class UndoRedoManager{constructor(i,n){this.configuration=i,this.context=new UndoRedoContext(n)}get globalEvent(){return GlobalEvent.getInstance()}updateCanUndoRedo(){this.context.canRedo=this.context.stack.length-1>this.context.stackIndex,this.context.canUndo=this.context.stackIndex>0}getLastModel(){return this.context.stack[this.context.stack.length-1]}getModelFromModificationDate(i){return this.context.stack.find((n=>n.modificationDate===i))}addModelToStack(i){this.context.stackIndex+1<this.context.stack.length&&this.context.stack.splice(this.context.stackIndex+1),this.context.stackIndex++,this.context.stack.push(i.getClone()),this.context.stack.length>this.configuration.maxStackSize&&(this.context.stack.shift(),this.context.stackIndex--),this.updateCanUndoRedo(),this.globalEvent.emitChange(this.context)}updateModelInStack(i){const n=this.context.stack.findIndex((n=>n.modificationDate===i.modificationDate));n>-1&&(this.context.stack.splice(n,1,i.getClone()),this.globalEvent.emitChange(this.context))}undo(){return this.context.canUndo&&(this.context.stackIndex--,this.updateCanUndoRedo(),this.globalEvent.emitChange(this.context)),this.context.stack[this.context.stackIndex].getClone()}redo(){return this.context.canRedo&&(this.context.stackIndex++,this.updateCanUndoRedo(),this.globalEvent.emitChange(this.context)),this.context.stack[this.context.stackIndex].getClone()}reset(i){this.context=new UndoRedoContext(i),this.globalEvent.emitChange(this.context)}}class RestBehaviors{constructor(i,n){this.grabber=new PointerEventGrabber(i.grabber),this.renderer=new CanvasRenderer(i.rendering),this.recognizer=new RestRecognizer(i.server,i.recognition),this.undoRedoManager=new UndoRedoManager(i["undo-redo"],n.getClone()),this._triggerConfiguration=i.triggers,this.initalise=new DeferredPromise}get globalEvent(){return GlobalEvent.getInstance()}_export(i,n){return __awaiter(this,void 0,void 0,(function*(){const s=yield this.recognizer.export(i,n);return this.globalEvent.emitExported(null==s?void 0:s.exports),s}))}init(i){return this.grabber.attach(i),this.renderer.init(i),this.initalise.resolve(),this.initalise.promise}drawCurrentStroke(i){this.renderer.drawPendingStroke(i.currentStroke)}updateModelRendering(i){return this.renderer.drawModel(i),this.export(i)}export(i,n){return __awaiter(this,void 0,void 0,(function*(){const s=new DeferredPromise;if(this.undoRedoManager.addModelToStack(i),"DEMAND"!==this._triggerConfiguration.exportContent){clearTimeout(this._exportTimer);let a=i.getClone();this._exportTimer=setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){try{a=yield this._export(a,n),this.undoRedoManager.updateModelInStack(a),i.modificationDate===a.modificationDate&&(i.exports=a.exports),s.resolve(i)}catch(i){s.reject(i)}}))),this._triggerConfiguration.exportContentDelay)}else s.resolve(i);return s.promise}))}convert(i,n,s){return __awaiter(this,void 0,void 0,(function*(){return this.recognizer.convert(i,n,s)}))}resize(i){return __awaiter(this,void 0,void 0,(function*(){if(this.renderer.resize(i),i.strokeGroups.length){const n=new DeferredPromise;return clearTimeout(this._resizeTimer),this._resizeTimer=setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){const s=yield this.recognizer.resize(i);n.resolve(s)}))),this._triggerConfiguration.resizeTriggerDelay),n.promise}return Promise.resolve(i)}))}undo(){return __awaiter(this,void 0,void 0,(function*(){const i=this.undoRedoManager.undo();this.renderer.drawModel(i);const n=yield this._export(i);return this.undoRedoManager.updateModelInStack(n),n}))}redo(){return __awaiter(this,void 0,void 0,(function*(){const i=this.undoRedoManager.redo();this.renderer.drawModel(i);const n=yield this._export(i);return this.undoRedoManager.updateModelInStack(n),n}))}clear(i){return __awaiter(this,void 0,void 0,(function*(){const n=i.getClone();return n.clear(),this.undoRedoManager.addModelToStack(n),this.renderer.drawModel(n),n.modificationDate=(new Date).getTime(),this.globalEvent.emitExported(n.exports),this.globalEvent.emitCleared(n),n}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return this.grabber.detach(),this.renderer.destroy(),Promise.resolve()}))}}class WSEvent extends EventTarget{constructor(){super(),this.abortController=new AbortController}emit(i,n){this.dispatchEvent(new CustomEvent(i,Object.assign({bubbles:!0,composed:!0},n?{detail:n}:void 0)))}emitInitialized(){this.emit(I)}emitConnected(){this.emit(N)}emitConnectionActive(){this.emit(R)}addConnectionActiveListener(i){this.addEventListener(R,(()=>i()),{signal:this.abortController.signal})}emitDisconnected(i){this.emit(O,i)}addDisconnectedListener(i){this.addEventListener(O,(n=>i(n.detail)),{signal:this.abortController.signal})}emitPartChange(i){this.emit(T,i)}addPartChangeListener(i){this.addEventListener(T,(n=>i(n.detail)),{signal:this.abortController.signal})}emitContentChange(i){this.emit(L,i)}addContentChangeListener(i){this.addEventListener(L,(n=>i(n.detail)),{signal:this.abortController.signal})}emitSVGPatch(i){this.emit(A,i)}addSVGPatchListener(i){this.addEventListener(A,(n=>i(n.detail)),{signal:this.abortController.signal})}emitExported(i){this.emit(D,i)}addExportListener(i){this.addEventListener(D,(n=>i(n.detail)),{signal:this.abortController.signal})}emitError(i){this.emit(z,i)}addErrorListener(i){this.addEventListener(z,(n=>i(n.detail)),{signal:this.abortController.signal})}clearListeners(){this.abortController.abort()}}class WSRecognizer extends AbstractRecognizer{constructor(i,n){super(i,n),this.pingCount=0,this.reconnectionCount=0,this.wsEvent=new WSEvent}get url(){return`${"https"===this.serverConfiguration.scheme?"wss":"ws"}://${this.serverConfiguration.host}/api/v4.0/iink/document`}get mimeTypes(){switch(this.recognitionConfiguration.type.toLocaleLowerCase()){case"text":return this.recognitionConfiguration.text.mimeTypes;case"math":return this.recognitionConfiguration.math.mimeTypes;case"diagram":return this.recognitionConfiguration.diagram.mimeTypes;default:return[]}}infinitePing(){this.pingCount++,this.serverConfiguration.websocket.maxPingLostCount<this.pingCount?this.close(1e3,"PING_LOST"):this.socket.readyState<=1&&setTimeout((()=>{this.socket.readyState<=1&&(this.socket.send(JSON.stringify({type:"ping"})),this.infinitePing())}),this.serverConfiguration.websocket.pingDelay)}openCallback(){this.wsEvent.emitConnected();const i={type:this.sessionId?"restoreIInkSession":"newContentPackage",iinkSessionId:this.sessionId,applicationKey:this.serverConfiguration.applicationKey,xDpi:96,yDpi:96,viewSizeHeight:this.viewSizeHeight,viewSizeWidth:this.viewSizeWidth};this.send(i)}closeCallback(i){let n="";if(!this.currentErrorCode){switch(i.code){case 1e3:break;case 1001:n=c;break;case 1002:n=h;break;case 1003:case 1005:n=l;break;case 1006:n=a;break;case 1007:n=p;break;case 1008:n=u;break;case 1009:n=g;break;case 1011:n=m;break;case 1012:n=v;break;case 1013:n=f;break;case 1014:n=y;break;case 1015:n=x;break;default:n=d}n&&this.wsEvent.emitError(new Error(n)),this.wsEvent.emitDisconnected(i)}}manageHMACChallengeMessage(i){const n=i;n.hmacChallenge&&this.send({type:"hmac",hmac:computeHmac(n.hmacChallenge,this.serverConfiguration.applicationKey,this.serverConfiguration.hmacKey)}),n.iinkSessionId&&(this.sessionId=n.iinkSessionId)}manageContentPackageDescriptionMessage(){this.reconnectionCount=0,this.send(Object.assign(Object.assign({},this.recognitionConfiguration),{type:"configuration"})),this.currentPartId?this.send({type:"openContentPart",id:this.currentPartId,mimeTypes:this.mimeTypes}):this.send({type:"newContentPart",contentType:this.recognitionConfiguration.type,mimeTypes:this.mimeTypes})}managePartChangeMessage(i){const n=i;this.currentPartId=n.partId,this.wsEvent.emitPartChange(n)}manageContentChangeMessage(i){const n=i;this.wsEvent.emitContentChange(n)}manageExportMessage(i){const n=i;this.wsEvent.emitExported(n)}manageSVGPatchMessage(i){const n=i;this.wsEvent.emitSVGPatch(n)}manageErrorMessage(i){var a,d;const c=i;this.currentErrorCode=(null===(a=c.data)||void 0===a?void 0:a.code)||c.code;let h=(null===(d=c.data)||void 0===d?void 0:d.message)||c.message||s;"access.not.granted"===this.currentErrorCode&&(h=n),this.wsEvent.emitError(new Error(h))}messageCallback(i){this.currentErrorCode=void 0;const n=JSON.parse(i.data);if("pong"!==n.type)switch(this.pingCount=0,n.type){case"ack":this.manageHMACChallengeMessage(n);break;case"contentPackageDescription":this.manageContentPackageDescriptionMessage();break;case"partChanged":this.managePartChangeMessage(n);break;case"newPart":this.wsEvent.emitConnectionActive();break;case"contentChanged":this.manageContentChangeMessage(n);break;case"exported":this.manageExportMessage(n);break;case"svgPatch":this.manageSVGPatchMessage(n);break;case"error":this.manageErrorMessage(n)}}init(i,n){try{this.viewSizeHeight=i,this.viewSizeWidth=n,this.socket=new WebSocket(this.url),this.serverConfiguration.websocket.pingEnabled&&this.infinitePing(),this.socket.onopen=()=>this.openCallback(),this.socket.onclose=i=>this.closeCallback(i),this.socket.onmessage=i=>this.messageCallback(i),this.wsEvent.emitInitialized()}catch(i){new Error(d).name=i.code||"CANT_ESTABLISH",this.wsEvent.emitError(i)}}canReconnect(){return this.serverConfiguration.websocket.autoReconnect&&this.reconnectionCount<=this.serverConfiguration.websocket.maxRetryCount&&(!this.currentErrorCode||!["api.invalid.format","access.not.granted"].includes(this.currentErrorCode.toString()))}addStrokes(i){const n=i.extractPendingStrokes();0!==n.length&&this.send({type:"addStrokes",strokes:n.map((i=>({pointerType:i.pointerType,pointerId:i.pointerId,x:i.x,y:i.y,t:i.t,p:i.p})))})}send(i){if(this.socket.readyState!==this.socket.OPEN)throw this.socket.removeEventListener("close",this.closeCallback),this.socket.removeEventListener("message",this.messageCallback),this.socket.removeEventListener("open",this.openCallback),new Error(O);this.socket.send(JSON.stringify(i))}close(i,n){this.socket.readyState!==this.socket.OPEN&&this.socket.readyState!==this.socket.CONNECTING||this.socket.close(i,n)}export(i,n){return __awaiter(this,void 0,void 0,(function*(){let s=n||[];if(!s.length)switch(this.recognitionConfiguration.type){case"DIAGRAM":s=this.recognitionConfiguration.diagram.mimeTypes;break;case"MATH":s=this.recognitionConfiguration.math.mimeTypes;break;case"Raw Content":s=["application/vnd.myscript.jiix"];break;case"TEXT":s=this.recognitionConfiguration.text.mimeTypes;break;default:throw new Error(`Recognition type "${this.recognitionConfiguration.type}" is unknown.\n Possible types are:\n -DIAGRAM\n -MATH\n -Raw Content\n -TEXT`)}if(!s.length)return Promise.reject(new Error("Export failed, no mimeTypes define in recognition configuration"));const a={type:"export",partId:this.currentPartId,mimeTypes:s};return this.send(a),i}))}resize(i){return __awaiter(this,void 0,void 0,(function*(){this.viewSizeHeight=i.height,this.viewSizeWidth=i.width;const n={type:"changeViewSize",height:this.viewSizeHeight,width:this.viewSizeWidth};return this.send(n),Promise.resolve(i)}))}convert(i){const n={type:"convert",conversionState:i};this.send(n)}undo(){this.send({type:"undo"})}redo(){this.send({type:"redo"})}clear(){this.send({type:"clear"})}}class SVGQuadraticStroker{getArcPath(i,n){return[`M ${i.x},${i.y}`,`m ${-n},0`,`a ${n},${n} 0 1 0 ${2*n},0`,`a ${n},${n} 0 1 0 ${-2*n},0`].join(" ")}getLinePath(i,n,s){const a=computeLinksPoints(i,computeAxeAngle(i,n),s),d=computeLinksPoints(n,computeAxeAngle(i,n),s);return[`M ${a[0].x},${a[0].y}`,`L ${d[0].x},${d[0].y}`,`L ${d[1].x},${d[1].y}`,`L ${a[1].x},${a[1].y}`].join(" ")}getFinalPath(i,n,s){const a=computeAxeAngle(i,n),d=computeLinksPoints(n,a,s),c=[`M ${d[0].x},${d[0].y}`];for(let i=1;i<=6;i++){const d=a-i*(Math.PI/6);c.push(`L ${n.x-n.p*s*Math.sin(d)},${n.y+n.p*s*Math.cos(d)}`)}return c.join(" ")}getQuadraticPath(i,n,s,a){const d=computeLinksPoints(i,computeAxeAngle(i,s),a),c=computeLinksPoints(n,computeAxeAngle(s,n),a),h=computeLinksPoints(s,computeAxeAngle(i,n),a);return[`M ${d[0].x},${d[0].y}`,`Q ${h[0].x},${h[0].y} ${c[0].x},${c[0].y}`,`L ${c[1].x},${c[1].y}`,`Q ${h[1].x},${h[1].y} ${d[1].x},${d[1].y}`].join(" ")}getPointByIndex(i,n){return{x:i.x[n]||0,y:i.y[n]||0,t:i.t[n]||0,p:i.p[n]||0}}buildSVGPath(i){const n=i.x.length,s=i.width,a=n-2,d=this.getPointByIndex(i,0),c=[];if(n<3)c.push(this.getArcPath(d,.6*s));else{c.push(this.getArcPath(d,s*d.p)),c.push(this.getLinePath(d,computeMiddlePoint(d,this.getPointByIndex(i,1)),s));for(let n=0;n<a;n++){const a=computeMiddlePoint(this.getPointByIndex(i,n),this.getPointByIndex(i,n+1)),d=computeMiddlePoint(this.getPointByIndex(i,n+1),this.getPointByIndex(i,n+2)),h=this.getPointByIndex(i,n+1);c.push(this.getQuadraticPath(a,d,h,s))}const h=this.getPointByIndex(i,n-2),l=this.getPointByIndex(i,n-1);c.push(this.getLinePath(computeMiddlePoint(h,l),l,s)),c.push(this.getFinalPath(h,l,s))}return c.join(" ")}drawStroke(i,n){const s=this.buildSVGPath(n),a=document.createElementNS("http://www.w3.org/2000/svg","path");a.classList.add("pending-stroke"),a.setAttribute("id",n.id),a.setAttribute("color",n.color);const d=`fill:${n.color};stroke:transparent;`;a.setAttribute("style",d),a.setAttribute("d",`${s}Z`),i.appendChild(a)}drawErasingStroke(i,n){n.width=20;const s=this.buildSVGPath(n),a=document.createElementNS("http://www.w3.org/2000/svg","path");a.classList.add("erasing-stroke"),a.setAttribute("id",n.id);a.setAttribute("style","fill:grey;stroke:transparent;shadowBlur:5;opacity:0.2;"),a.setAttribute("d",`${s}Z`),i.appendChild(a)}}class SVGRenderer{constructor(i){this.config=i,this.stroker=new SVGQuadraticStroker}init(i){i.style.fontSize="10px",this.context={parent:i}}_drawStroke(i,n){"ERASER"===n.pointerType?this.stroker.drawErasingStroke(i,n):this.stroker.drawStroke(i,n)}replaceAll(i,n){const s=this.context.parent.querySelector(`svg[data-layer="${i}"]`);null==s||s.remove(),this.context.parent.insertAdjacentHTML("beforeend",n.svg);const a=this.context.parent.querySelector(`svg[data-layer="${i}"]`);if("MODEL"===i){const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.id="pendingStrokes",a.appendChild(i)}}replaceElement(i){const n=this.context.parent.querySelector(`#${i.id}`);if(n){const s=n.parentNode;null==n||n.remove(),null==s||s.insertAdjacentHTML("beforeend",i.svg)}}appendChild(i,n){const s=n.parentId?`#${n.parentId}`:`svg[data-layer="${i}"]`,a=this.context.parent.querySelector(s);null==a||a.insertAdjacentHTML("beforeend",n.svg)}removeChild(i){var n;null===(n=this.context.parent.querySelector(`#${i.parentId} > *:nth-child(${i.index+1})`))||void 0===n||n.remove()}removeElement(i){const n=this.context.parent.querySelector(`#${i.id}`);n&&(i.id.includes("s")||i.id.includes("MODEL")?n.remove():(n.setAttribute("class","removed-stroke"),setTimeout((()=>{null==n||n.remove()}),100)))}insertBefore(i){const n=this.context.parent.querySelector(`#${i.refId}`);null==n||n.insertAdjacentHTML("beforebegin",i.svg)}setAttribut(i){const n=i.id?`#${i.id}`:"svg",s=this.context.parent.querySelector(n);null==s||s.setAttribute(i.name,i.value)}removeAttribut(i){const n=i.id?`#${i.id}`:"svg",s=this.context.parent.querySelector(n);null==s||s.removeAttribute(i.name)}updateLayer(i,n){switch(n.type){case"REPLACE_ALL":this.replaceAll(i,n);break;case"REPLACE_ELEMENT":this.replaceElement(n);break;case"APPEND_CHILD":this.appendChild(i,n);break;case"REMOVE_ELEMENT":this.removeElement(n);break;case"REMOVE_CHILD":this.removeChild(n);break;case"INSERT_BEFORE":this.insertBefore(n);break;case"SET_ATTRIBUTE":this.setAttribut(n);break;case"REMOVE_ATTRIBUTE":this.removeAttribut(n)}}updatesLayer(i,n){n.forEach((n=>this.updateLayer(i,n)))}clearPendingStroke(){const i=this.context.parent.querySelector("#pendingStrokes");i&&(i.innerHTML="")}drawPendingStroke(i){if(i){const n=this.context.parent.querySelector("#pendingStrokes");if(n){const s=n.querySelector(`#${null==i?void 0:i.id}`);s&&s.remove(),this._drawStroke(n,i)}}}resize(i){const n=this.context.parent.getBoundingClientRect(),s=this.context.parent.querySelectorAll("svg"),a=Math.max(n.width,i.width),d=Math.max(n.height,i.height);s.forEach((i=>{i.setAttribute("viewBox",`0 0 ${a}, ${d}`),i.setAttribute("width",`${a}px`),i.setAttribute("height",`${d}px`)}))}destroy(){for(;this.context.parent.lastChild;)this.context.parent.removeChild(this.context.parent.lastChild)}}class WSBehaviors{constructor(i,n){this.onConnectionActive=()=>{this.initalise.resolve()},this.onContentChange=()=>{var i,n,s,a;null===(i=this._resizeDeffered)||void 0===i||i.resolve(),null===(n=this._undoDeffered)||void 0===n||n.resolve(),null===(s=this._redoDeffered)||void 0===s||s.resolve(),null===(a=this._clearDeffered)||void 0===a||a.resolve()},this.onSVGPatch=i=>{this.renderer.updatesLayer(i.layer,i.updates)},this.onError=i=>{this.initalise.isPending&&this.initalise.reject(i),this.globalEvent.emitError(i)},this.onExport=i=>{var n,s;null===(n=this._addStrokeDeffered)||void 0===n||n.resolve(i.exports),null===(s=this._exportDeffered)||void 0===s||s.resolve(i.exports),this.globalEvent.emitExported(i.exports)},this.onDisconnected=i=>{var n,s,a,d,c,h,l,p,u,g;const m=new Error(i.reason);m.name=i.code.toString(),this.initalise.isPending&&(1e3===i.code?this.initalise.resolve():this.initalise.reject(m)),(null===(n=this._addStrokeDeffered)||void 0===n?void 0:n.isPending)&&(null===(s=this._addStrokeDeffered)||void 0===s||s.reject(m)),(null===(a=this._resizeDeffered)||void 0===a?void 0:a.isPending)&&(null===(d=this._resizeDeffered)||void 0===d||d.reject(m)),(null===(c=this._undoDeffered)||void 0===c?void 0:c.isPending)&&(null===(h=this._undoDeffered)||void 0===h||h.reject(m)),(null===(l=this._redoDeffered)||void 0===l?void 0:l.isPending)&&(null===(p=this._redoDeffered)||void 0===p||p.reject(m)),(null===(u=this._clearDeffered)||void 0===u?void 0:u.isPending)&&(null===(g=this._clearDeffered)||void 0===g||g.reject(m))},this.grabber=new PointerEventGrabber(i.grabber),this.renderer=new SVGRenderer(i.rendering),this.recognizer=new WSRecognizer(i.server,i.recognition),this.undoRedoManager=new UndoRedoManager(i["undo-redo"],n.getClone()),this._triggerConfiguration=i.triggers,this.initalise=new DeferredPromise}get globalEvent(){return GlobalEvent.getInstance()}init(i){const n=this.undoRedoManager.getLastModel();return this.grabber.attach(i),this.renderer.init(i),this.recognizer.init(n.height,n.width),this.recognizer.wsEvent.addConnectionActiveListener(this.onConnectionActive),this.recognizer.wsEvent.addContentChangeListener(this.onContentChange),this.recognizer.wsEvent.addSVGPatchListener(this.onSVGPatch),this.recognizer.wsEvent.addExportListener(this.onExport),this.recognizer.wsEvent.addDisconnectedListener(this.onDisconnected),this.recognizer.wsEvent.addErrorListener(this.onError),this.initalise.promise}drawCurrentStroke(i){const n=i.currentStroke;n&&(n.id=`pendingStroke-${i.rawStrokes.length}`,this.renderer.drawPendingStroke(n))}updateModelRendering(i){return __awaiter(this,void 0,void 0,(function*(){yield this.initalise.promise,i.updatePositionSent(),this.undoRedoManager.addModelToStack(i),this._addStrokeDeffered=new DeferredPromise,this.recognizer.addStrokes(i);const n=yield this._addStrokeDeffered.promise;return i.updatePositionReceived(),i.exports?Object.assign(i.exports,n):i.exports=n,this.undoRedoManager.updateModelInStack(i),this.renderer.clearPendingStroke(),this._addStrokeDeffered=void 0,i}))}export(i,n){return __awaiter(this,void 0,void 0,(function*(){yield this.initalise.promise,this.undoRedoManager.addModelToStack(i),this._exportDeffered=new DeferredPromise,yield this.recognizer.export(i,n);const s=yield this._exportDeffered.promise;return i.updatePositionReceived(),i.exports?Object.assign(i.exports,s):i.exports=s,this.undoRedoManager.updateModelInStack(i),this._exportDeffered=void 0,i}))}convert(i,n){return __awaiter(this,void 0,void 0,(function*(){yield this.initalise.promise,this.undoRedoManager.addModelToStack(i),this._convertDeffered=new DeferredPromise,this.recognizer.convert(n);const s=yield this._convertDeffered.promise;return i.updatePositionReceived(),i.converts?Object.assign(i.converts,s):i.converts=s,this.undoRedoManager.updateModelInStack(i),this._convertDeffered=void 0,i}))}resize(i){return __awaiter(this,void 0,void 0,(function*(){return yield this.initalise.promise,this.renderer.resize(i),this._resizeDeffered=new DeferredPromise,clearTimeout(this._resizeTimer),this._resizeTimer=setTimeout((()=>__awaiter(this,void 0,void 0,(function*(){this.recognizer.resize(i)}))),this._triggerConfiguration.resizeTriggerDelay),yield this._resizeDeffered.promise,this._resizeDeffered=void 0,i}))}undo(){return __awaiter(this,void 0,void 0,(function*(){return yield this.initalise.promise,this._undoDeffered=new DeferredPromise,this.recognizer.undo(),yield this._undoDeffered.promise,this.undoRedoManager.undo()}))}redo(){return __awaiter(this,void 0,void 0,(function*(){return yield this.initalise.promise,this._redoDeffered=new DeferredPromise,this.recognizer.redo(),yield this._redoDeffered.promise,this.undoRedoManager.redo()}))}clear(i){var n;return __awaiter(this,void 0,void 0,(function*(){yield this.initalise.promise,this._clearDeffered=new DeferredPromise,this.recognizer.clear();const s=i.getClone();return s.clear(),this.undoRedoManager.addModelToStack(s),yield null===(n=this._clearDeffered)||void 0===n?void 0:n.promise,this._clearDeffered=void 0,s}))}destroy(){return __awaiter(this,void 0,void 0,(function*(){return this.grabber.detach(),this.renderer.destroy(),this.recognizer.close(1e3,W),Promise.resolve()}))}}class BehaviorsManager{constructor(i,n,s){this.overrideDefaultBehaviors(i,n,s)}overrideDefaultBehaviors(i,n,s){let a;this.behaviors&&this.behaviors.destroy(),a="REST"===i.server.protocol?new RestBehaviors(i,n):new WSBehaviors(i,n),this.behaviors=Object.assign(a,s)}init(i){return this.behaviors.init(i)}}const q={server:{protocol:"WEBSOCKET",scheme:"https",host:"webdemoapi.myscript.com",applicationKey:"",hmacKey:"",useWindowLocation:!1,websocket:{pingEnabled:!0,pingDelay:3e4,maxPingLostCount:10,autoReconnect:!0,maxRetryCount:2,fileChunkSize:3e5}},recognition:{type:"TEXT",alwaysConnected:!0,lang:"en_US",gesture:{enable:!0},export:{"image-resolution":300,jiix:{"bounding-box":!1,strokes:!1,text:{chars:!1,words:!0}}},renderer:{debug:{"draw-text-boxes":!1,"draw-image-boxes":!1}},math:{mimeTypes:["application/x-latex"],solver:{enable:!0,"fractional-part-digits":3,"decimal-separator":".","rounding-mode":"half up","angle-unit":"deg"},margin:{bottom:10,left:15,right:15,top:10},eraser:{"erase-precisely":!1},"undo-redo":{mode:"stroke"}},text:{guides:{enable:!0},mimeTypes:["text/plain"],margin:{top:20,left:10,right:10,bottom:10},eraser:{"erase-precisely":!1}},diagram:{mimeTypes:["application/vnd.myscript.jiix"],eraser:{"erase-precisely":!1}},"raw-content":{recognition:{text:!0,shape:!1},eraser:{"erase-precisely":!1}}},grabber:{listenerOptions:{capture:!1,passive:!0},xyFloatPrecision:0,timestampFloatPrecision:0},rendering:{minHeight:100,minWidth:100,smartGuide:{enable:!1,fadeOut:{enable:!1,duration:1e4}}},triggers:{exportContent:"POINTER_UP",exportContentDelay:1e3,resizeTriggerDelay:100},events:{processDelay:10},"undo-redo":{maxStackSize:10}};class Configuration{constructor(i){this.events=JSON.parse(JSON.stringify(q.events)),this.grabber=JSON.parse(JSON.stringify(q.grabber)),this.recognition=JSON.parse(JSON.stringify(q.recognition)),this.rendering=JSON.parse(JSON.stringify(q.rendering)),this.server=JSON.parse(JSON.stringify(q.server)),this.triggers=JSON.parse(JSON.stringify(q.triggers)),this.overrideDefaultConfiguration(i)}mergeDeep(i,...n){const isObject=i=>i&&"object"==typeof i&&!Array.isArray(i);if(!n.length)return i;const s=n.shift();if(isObject(i)&&isObject(s))for(const n in s)isObject(s[n])?(i[n]||Object.assign(i,{[n]:{}}),this.mergeDeep(i[n],s[n])):Object.assign(i,{[n]:s[n]});return this.mergeDeep(i,...n)}overrideDefaultConfiguration(i){var n,s,a,d,c,h,l;this.events=this.mergeDeep({},q.events,null==i?void 0:i.events),this.grabber=this.mergeDeep({},q.grabber,null==i?void 0:i.grabber),this.recognition=this.mergeDeep({},q.recognition,null==i?void 0:i.recognition),this.rendering=this.mergeDeep({},q.rendering,null==i?void 0:i.rendering),this.server=this.mergeDeep({},q.server,null==i?void 0:i.server),this.triggers=this.mergeDeep({},q.triggers,null==i?void 0:i.triggers),this["undo-redo"]=this.mergeDeep({},q["undo-redo"],null==i?void 0:i["undo-redo"]),this.recognition.text.mimeTypes=(null===(s=null===(n=null==i?void 0:i.recognition)||void 0===n?void 0:n.text)||void 0===s?void 0:s.mimeTypes)||q.recognition.text.mimeTypes,this.recognition.math.mimeTypes=(null===(d=null===(a=null==i?void 0:i.recognition)||void 0===a?void 0:a.math)||void 0===d?void 0:d.mimeTypes)||q.recognition.math.mimeTypes,this.recognition.diagram.mimeTypes=(null===(h=null===(c=null==i?void 0:i.recognition)||void 0===c?void 0:c.diagram)||void 0===h?void 0:h.mimeTypes)||q.recognition.diagram.mimeTypes,(null===(l=this.server)||void 0===l?void 0:l.useWindowLocation)&&(this.server.scheme=window.location.protocol.indexOf("s")>-1?"https":"http",this.server.host=window.location.host),"REST"===this.server.protocol&&"POINTER_UP"===this.triggers.exportContent&&(this.triggers.exportContent="QUIET_PERIOD",this.triggers.exportContentDelay=Math.max(this.triggers.exportContentDelay,50)),"WEBSOCKET"===this.server.protocol&&"TEXT"===this.recognition.type?this.rendering.smartGuide.enable&&!this.recognition.text.mimeTypes.includes("application/vnd.myscript.jiix")&&this.recognition.text.mimeTypes.push("application/vnd.myscript.jiix"):this.rendering.smartGuide.enable=!1}}class Stroke{constructor(i,n,s="pen"){this.type="stroke",this.pointerId=n,this.pointerType=s,this.x=[],this.y=[],this.t=[],this.p=[],this.l=[],this.color=i.color,this.width=i.width,this["-myscript-pen-width"]=i["-myscript-pen-width"],this["-myscript-pen-fill-style"]=i["-myscript-pen-fill-style"],this["-myscript-pen-fill-color"]=i["-myscript-pen-fill-color"]}}class Model{constructor(i,n,s=(new Date).getTime()){this.rawStrokes=[],this.strokeGroups=[],this.positions={lastSentPosition:-1,lastReceivedPosition:-1,lastRenderedPosition:-1},this.defaultSymbols=[],this.creationTime=s,this.modificationDate=s,this.width=i,this.height=n,this.idle=!0,this.isEmpty=!0}computeDistance(i,n){const s=Math.sqrt(Math.pow(i.y-n.y,2)+Math.pow(i.x-n.x,2));return isNaN(s)?0:s}computeLength(i,n,s){const a=s+this.computeDistance(i,n);return isNaN(a)?0:a}computePressure(i,n,s){let a=1;const d=this.computeDistance(i,n),c=this.computeLength(i,n,s);0===c?a=.5:d===c?a=1:d<10?a=.2+Math.pow(.1*d,.4):d>c-10&&(a=.2+Math.pow(.1*(c-d),.4));const h=a*Math.max(.1,1-.1*Math.sqrt(d));return isNaN(h)?.5:Math.round(100*h)/100}filterPointByAcquisitionDelta(i,n){const s=2+i["-myscript-pen-width"]/4;return 0===i.x.length||0===i.y.length||Math.abs(i.x[i.x.length-1]-n.x)>=s||Math.abs(i.y[i.y.length-1]-n.y)>=s}addPoint(i,n){if(this.filterPointByAcquisitionDelta(i,n)){const s={x:i.x[i.x.length-1],y:i.y[i.y.length-1],p:i.p[i.p.length-1],t:i.t[i.t.length-1]},a=i.l[i.l.length-1];i.x.push(n.x),i.y.push(n.y),i.t.push(n.t),i.p.push(this.computePressure(n,s,a)),i.l.push(this.computeLength(n,s,a))}}addStroke(i){this.rawStrokes.push(i)}extractPendingStrokes(i=this.positions.lastReceivedPosition+1){return this.rawStrokes.slice(i)}addStrokeToGroup(i,n){const s=this.strokeGroups.length-1;if(this.strokeGroups[s]&&(a=this.strokeGroups[s].penStyle,d=n,a["-myscript-pen-fill-color"]===d["-myscript-pen-fill-color"]&&a["-myscript-pen-fill-style"]===d["-myscript-pen-fill-style"]&&a["-myscript-pen-width"]===d["-myscript-pen-width"]&&a.color===d.color&&a.width===d.width))this.strokeGroups[s].strokes.push(i);else{const s={penStyle:n,strokes:[i]};this.strokeGroups.push(s)}var a,d;this.isEmpty=!1}initCurrentStroke(i,n,s,a,d=96){if(a["-myscript-pen-width"]){const i=a["-myscript-pen-width"]*d/25.4;a.width=i/2}this.modificationDate=(new Date).getTime(),this.exports=void 0,this.converts=void 0,this.currentStroke=new Stroke(a,n,s),this.addPoint(this.currentStroke,i)}appendToCurrentStroke(i){this.currentStroke&&this.addPoint(this.currentStroke,i)}endCurrentStroke(i,n){this.currentStroke&&(this.addPoint(this.currentStroke,i),this.addStroke(this.currentStroke),this.addStrokeToGroup(this.currentStroke,n),this.currentStroke=void 0)}extractPendingRecognizedSymbols(i=this.positions.lastRenderedPosition+1){return this.recognizedSymbols?this.recognizedSymbols.slice(i):[]}updatePositionSent(i=this.rawStrokes.length-1){this.positions.lastSentPosition=i}updatePositionReceived(){this.positions.lastReceivedPosition=this.positions.lastSentPosition}updatePositionRendered(i=(this.recognizedSymbols?this.recognizedSymbols.length-1:-1)){this.positions.lastRenderedPosition=i}resetPositionRenderer(){this.positions.lastRenderedPosition=-1}resetPositions(){this.positions.lastSentPosition=-1,this.positions.lastReceivedPosition=-1}getClone(){const i=new Model(this.width,this.height,this.creationTime);return i.modificationDate=JSON.parse(JSON.stringify(this.modificationDate)),i.defaultSymbols=JSON.parse(JSON.stringify(this.defaultSymbols)),i.currentStroke=this.currentStroke?JSON.parse(JSON.stringify(this.currentStroke)):void 0,i.rawStrokes=JSON.parse(JSON.stringify(this.rawStrokes)),i.strokeGroups=JSON.parse(JSON.stringify(this.strokeGroups)),i.positions=JSON.parse(JSON.stringify(this.positions)),i.exports=this.exports?JSON.parse(JSON.stringify(this.exports)):void 0,i.converts=this.converts?JSON.parse(JSON.stringify(this.converts)):void 0,i.recognizedSymbols=this.recognizedSymbols?JSON.parse(JSON.stringify(this.recognizedSymbols)):void 0,i.idle=this.idle,i.isEmpty=this.isEmpty,i}clear(){this.modificationDate=(new Date).getTime(),this.currentStroke=void 0,this.rawStrokes=[],this.strokeGroups=[],this.positions.lastSentPosition=-1,this.positions.lastReceivedPosition=-1,this.positions.lastRenderedPosition=-1,this.recognizedSymbols=void 0,this.exports=void 0,this.converts=void 0,this.idle=!0,this.isEmpty=!0}}const Q={color:"#000000",width:0,"-myscript-pen-width":1,"-myscript-pen-fill-style":"none","-myscript-pen-fill-color":"#FFFFFF00"},Y={ink:{color:"#000000",width:1,"-myscript-pen-width":1,"-myscript-pen-fill-style":"none","-myscript-pen-fill-color":"#FFFFFF00"},".math":{"font-family":"STIXGeneral"},".math-solved":{"font-family":"STIXGeneral",color:"#A8A8A8FF"},".text":{"font-family":"MyScriptInter","font-size":10}};class StyleManager{constructor(i,n){this.overrideDefaultPenStyle(i),this.overrideDefaultTheme(n)}get penStyle(){return this._penStyle}get theme(){return this._theme}overrideDefaultPenStyle(i){const n=Object.assign(Object.assign({},Q),i||{});this._penStyle=n}overrideDefaultTheme(i){const n=Object.assign(Object.assign({},Y),i||{});this._theme=n}}var Z;!function styleInject(i,n){void 0===n&&(n={});var s=n.insertAt;if(i&&"undefined"!=typeof document){var a=document.head||document.getElementsByTagName("head")[0],d=document.createElement("style");d.type="text/css","top"===s&&a.firstChild?a.insertBefore(d,a.firstChild):a.appendChild(d),d.styleSheet?d.styleSheet.cssText=i:d.appendChild(document.createTextNode(i))}}("/* @import url(../node_modules/perfect-scrollbar/css/perfect-scrollbar.css); */\n\n.ms-editor {\n    position: relative;\n    z-index: 20;\n    color: #1A9FFF;\n    font-family: sans-serif;\n}\n\n.ms-editor.erasing {\n    cursor: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAEsSURBVDiNrdO7SgNBFMbx/3fmCbQ1tunDIayFBvFSKxbxBfSdBPEBtLIWb3Ebl4R9AQWLkE70CWbHZl1Eg2iSr5vL+c1hhhFTMhwOdyX1gQ2gVU+PgTyldNHtdq+/1+jroCiKtpmdSupNO6ApkgZmdtzpdJ5+QGVZ9qqqugSWfkO+5F3SnrvnDVQURTuE8PgP5DNvkjJ3fzaAEMLJDAjAclVVZwCqL/ZqBqSJme2YpMN5EIAYY9+A9XkhST0DVuaFgJYtAAGoDJgsAJoYkM+rSHqwlNL5Ajq6EMBoNLoBtmbsZuDumwYQYzwCXmdw3oAjAAPIsuxF0kG98GdE0r67PzcQgLvnIYQ14P4PyF39WZuH0rRdZVluxxj7kjaA1Xp6nFLKzezc3W+/13wAItdV6XjME1AAAAAASUVORK5CYII=') 10 10, auto;\n}\n\n.ms-editor canvas,\n.ms-editor svg {\n    z-index: 15;\n    position: absolute;\n    left: 0;\n    top: 0;\n    height: 100%;\n    width: 100%;\n}\n\n.ms-editor canvas.ms-rendering-canvas {\n    z-index: 10;\n    pointer-events: none;\n    background-image: linear-gradient(to right, #F5F6F7 1px, transparent 1px),\n    linear-gradient(to bottom, #F5F6F7 1px, transparent 1px);\n    background-size: 18px 18px;\n}\n\n.ms-editor svg {\n    z-index: 10;\n    pointer-events: none;\n}\n.ms-editor svg[data-layer=\"BACKGROUND\"] {\n    z-index: 9;\n}\n\n.ms-editor .loader {\n    z-index: 30;\n    position: absolute;\n    width: 120px;\n    height: 120px;\n    top: calc(50% - 60px);\n    left: calc(50% - 60px);\n    border: 16px solid #F5F6F7;\n    border-radius: 50%;\n    border-top-color: #1A9FFF;\n    -webkit-animation: spin 2s linear infinite;\n    animation: spin 2s linear infinite;\n}\n\n.ms-editor .error-msg {\n    z-index: 25;\n    position: absolute;\n    width: 200px;\n    height: 200px;\n    top: calc(50% - 100px);\n    left: calc(50% - 100px);\n    font-size: 16px;\n    text-align: center;\n    word-wrap: break-word;\n}\n\n.ms-editor .error-msg::before {\n    content: url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCA3Ni41IDYxMiA0NTkiIHByZXNlcnZlQXNwZWN0UmF0aW89InhNaW5ZTWluIG1lZXQiPgogICAgPHBhdGggZmlsbD0iIzFBOUZGRiIgZD0iTTQ5NC43LDIyOS41Yy0xNy44NTEtODYuNy05NC4zNTEtMTUzLTE4OC43LTE1M2MtMzguMjUsMC03My45NSwxMC4yLTEwMiwzMC42bDM4LjI1LDM4LjI1IGMxNy44NS0xMi43NSw0MC44LTE3Ljg1LDYzLjc1LTE3Ljg1Yzc2LjUsMCwxNDAuMjUsNjMuNzUsMTQwLjI1LDE0MC4yNXYxMi43NWgzOC4yNWM0My4zNSwwLDc2LjUsMzMuMTUsNzYuNSw3Ni41IGMwLDI4LjA1LTE1LjMsNTMuNTUtNDAuOCw2Ni4zbDM4LjI1LDM4LjI1QzU5MS42LDQzOC42LDYxMiw0MDAuMzUsNjEyLDM1N0M2MTIsMjkwLjcsNTU4LjQ1LDIzNC42LDQ5NC43LDIyOS41eiBNNzYuNSwxMDkuNjUgbDcxLjQsNjguODVDNjYuMywxODMuNiwwLDI0OS45LDAsMzMxLjVjMCw4NC4xNSw2OC44NSwxNTMsMTUzLDE1M2gyOTguMzVsNTEsNTFsMzMuMTUtMzMuMTVMMTA5LjY1LDc2LjVMNzYuNSwxMDkuNjV6IE0xOTYuMzUsMjI5LjVsMjA0LDIwNEgxNTNjLTU2LjEsMC0xMDItNDUuOS0xMDItMTAyYzAtNTYuMSw0NS45LTEwMiwxMDItMTAySDE5Ni4zNXoiIC8+Cjwvc3ZnPgo=);\n}\n\n.ms-editor .smartguide {\n    position: absolute;\n    z-index: 40;\n    font-size: 16px;\n}\n\n.ms-editor .smartguide.smartguide-in {\n    visibility: visible !important;\n    transition: opacity 0.5s;\n    opacity: 1;\n}\n\n.ms-editor .smartguide.smartguide-out {\n    transition: opacity 1s, visibility 1s;\n    visibility: hidden !important;\n    opacity: 0;\n}\n\n.ms-editor .smartguide .tag-icon {\n    padding: 0 18px;\n    border: 1px solid #959DA6;\n    font-weight: bold;\n    font-size: large;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n    position: absolute;\n    z-index: 31;\n    height: 48px;\n    line-height: 48px;\n    background-color: rgba(255, 255, 255, 0.9);\n    color: #959DA6;\n}\n\n.ms-editor .smartguide .ellipsis {\n    cursor: pointer;\n    border-bottom: 1px solid #959DA6;\n    position: absolute;\n    z-index: 31;\n    height: 48px;\n    line-height: 38px;\n    padding: 0 8px;\n    font-weight: bold;\n    font-size: x-large;\n    background-color: rgba(255, 255, 255, 0.9);\n    color: #959DA6;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n    -webkit-tap-highlight-color: transparent;\n}\n\n.ms-editor .smartguide .ellipsis:active {\n    background-color: #e0e0e0;\n}\n\n.ms-editor .smartguide .prompter-text-container {\n    background-color: rgba(255, 255, 255, 0.9);\n    height: 48px;\n    line-height: 48px;\n    overflow: hidden;\n    white-space: nowrap;\n    display: block;\n    text-align: left;\n    border-bottom: 1px solid #959DA6;\n    position: absolute;\n    z-index: 30;\n    color: #bfbfbf;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n    -webkit-tap-highlight-color: transparent;\n}\n\n.ms-editor .smartguide .prompter-text-container > div > span {\n    cursor: pointer;\n    display: inline-block;\n}\n\n.ms-editor .smartguide .prompter-text-container .prompter-text {\n    margin-left: 12px;\n}\n\n.ms-editor .smartguide .prompter-text-container .prompter-text .added-word {\n    animation: 0.1s linear word-added,\n    3s ease-in-out color-input;\n}\n\n.ms-editor .smartguide .prompter-text-container .prompter-text .modified-word {\n    animation: 0.1s linear word-modified,\n    3s ease-in-out color-input;\n}\n\n.ms-editor .smartguide .candidates {\n    color: black;\n    flex-direction: column;\n    text-align: center;\n    line-height: 30px;\n    border-radius: 3px;\n    position: absolute;\n    box-shadow: 2px 2px 12px #BDBDBD, -2px 2px 12px #BDBDBD;\n    background-color: #F5F5F5;\n    z-index: 100;\n    -webkit-tap-highlight-color: transparent;\n}\n\n.ms-editor .smartguide .candidates > span {\n    cursor: pointer;\n    padding: 2px 20px;\n}\n\n.ms-editor .smartguide .candidates > span:hover {\n    background-color: #EEEEEE;\n}\n\n.ms-editor .smartguide .candidates > span:active {\n    background-color: #E0E0E0;\n}\n\n.ms-editor .smartguide .candidates .selected-word {\n    font-weight: bold;\n    background-color: #E0E0E0;\n}\n\n.ms-editor .smartguide .more-menu {\n    flex-direction: column;\n    margin-right: 12px;\n    line-height: 30px;\n    border-radius: 3px;\n    position: absolute;\n    z-index: 100;\n    box-shadow: 2px 2px 12px #BDBDBD;\n    background-color: #F5F5F5;\n}\n\n.ms-editor .smartguide .more-menu .options-label-button {\n    color: black;\n    font-size: 16px;\n    cursor: pointer;\n    box-sizing: border-box;\n    background: transparent;\n    border: none;\n    padding: 0 24px;\n    margin: 0;\n    height: 40px;\n    outline: none;\n    -webkit-tap-highlight-color: transparent;\n}\n\n.ms-editor .smartguide .more-menu .options-label-button:hover {\n    background-color: #EEEEEE;\n}\n\n.ms-editor .smartguide .more-menu .options-label-button:active {\n    background-color: #E0E0E0;\n}\n\n.ms-editor .ps__rail-x {\n    top: 32px !important;\n}\n\n/** Stroke **/\n\n.ms-editor .removed-stroke {\n    opacity: 0;\n    transition: opacity 0.1s ease-in-out;\n}\n\n.ms-editor .added-stroke {\n    animation: 0.2s opacity-appear;\n}\n\n@keyframes color-input {\n    0% {\n        color: black;\n    }\n    100% {\n        color: #bfbfbf;\n    }\n}\n\n@keyframes word-added {\n    0% {\n        transform: translate(5px, 0);\n    }\n    100% {\n        transform: none;\n    }\n}\n\n@keyframes word-modified {\n    0% {\n        transform: translate(0, 5px);\n    }\n    100% {\n        transform: none;\n    }\n}\n\n@keyframes opacity-appear {\n    0% {\n        opacity: 0;\n    }\n    100% {\n        opacity : 1;\n    }\n}\n\n@keyframes spin {\n    0% {\n        transform: rotate(0deg);\n    }\n    100% {\n        transform: rotate(360deg);\n    }\n}\n\n@-webkit-keyframes spin {\n    0% {\n        -webkit-transform: rotate(0deg);\n    }\n    100% {\n        -webkit-transform: rotate(360deg);\n    }\n}\n"),function(i){i.Mouse="mouse",i.Pen="pen",i.Touche="touch",i.Eraser="eraser"}(Z||(Z={}));i.Editor=class Editor{constructor(i,n){this._initialized=!1,this.debug=!1,this.wrapperHTML=i,this.wrapperHTML.classList.add((null==n?void 0:n.globalClassCss)||"ms-editor"),this._loaderHTML=document.createElement("div"),this._loaderHTML.classList.add("loader"),this._loaderHTML=this.wrapperHTML.appendChild(this._loaderHTML),this._loaderHTML.style.display="initial",this._errorHTML=document.createElement("div"),this._errorHTML.classList.add("error-msg"),this._errorHTML=this.wrapperHTML.appendChild(this._errorHTML),this._errorHTML.style.display="none",this._mode=Z.Pen,this._styleManager=new StyleManager(null==n?void 0:n.penStyle,null==n?void 0:n.theme),this._configuration=new Configuration(null==n?void 0:n.configuration);const s=Math.max(this.wrapperHTML.clientWidth,this.configuration.rendering.minWidth),a=Math.max(this.wrapperHTML.clientHeight,this.configuration.rendering.minHeight);this.model=new Model(s,a),this._behaviorsManager=new BehaviorsManager(this.configuration,this.model,null==n?void 0:n.behaviors),this.initalizeBehaviors()}get initialized(){return this._initialized}get configuration(){return this._configuration}set configuration(i){this.model.isEmpty||this.model.clear(),this._configuration.overrideDefaultConfiguration(i),this.model.height=Math.max(this.wrapperHTML.clientHeight,this._configuration.rendering.minHeight),this.model.width=Math.max(this.wrapperHTML.clientWidth,this._configuration.rendering.minWidth),this._behaviorsManager.overrideDefaultBehaviors(this._configuration,this.model),this.initalizeBehaviors()}get behaviors(){return this._behaviorsManager.behaviors}get grabber(){return this._behaviorsManager.behaviors.grabber}get theme(){return this._styleManager.theme}get penStyle(){return this._styleManager.penStyle}get mode(){return this._mode}get events(){return GlobalEvent.getInstance()}initalizeBehaviors(){this._behaviorsManager.init(this.wrapperHTML).then((()=>__awaiter(this,void 0,void 0,(function*(){this.grabber.onPointerDown=(i,n)=>this.pointerDown(i,n),this.grabber.onPointerMove=(i,n)=>this.pointerMove(i,n),this.grabber.onPointerUp=(i,n)=>this.pointerUp(i,n),this.events.addEventListener(P,(i=>this.handleError(i))),this.events.addEventListener(k,this.clear),this._initialized=!0,this.wrapperHTML.editor=this,this.events.emitLoaded()})))).catch((i=>{this._initialized=!1,this.showError(i),this.events.emitError(i)})).finally((()=>{this._loaderHTML.style.display="none"}))}showError(i){if(this._errorHTML.style.display="initial",this._errorHTML.innerText=i.message,this.debug){const n=document.createElement("p");n.innerHTML=i.name,this._errorHTML.prepend(n);const s=document.createElement("p");s.style.width="50vw",s.style.marginLeft="calc(-25vw + 100px)",s.innerHTML=i.stack||"",this._errorHTML.appendChild(s)}}handleError(i){const n=i,s=null==n?void 0:n.detail;this.showError(s)}pointerDown(i,n){var s,a;const d=i.target;if((null==d?void 0:d.id)===this.wrapperHTML.id||(null===(s=null==d?void 0:d.classList)||void 0===s?void 0:s.contains("ms-canvas"))){let{pointerType:s}=i;this._mode===Z.Eraser&&(s=Z.Eraser);const d=Object.assign({},null===(a=this.theme)||void 0===a?void 0:a.ink,this.penStyle);this.model.initCurrentStroke(n,i.pointerId,s,d),this.behaviors.drawCurrentStroke(this.model)}}pointerMove(i,n){this.model.appendToCurrentStroke(n),this.behaviors.drawCurrentStroke(this.model)}pointerUp(i,n){return __awaiter(this,void 0,void 0,(function*(){this.model.endCurrentStroke(n,this.penStyle);try{this.model=yield this.behaviors.updateModelRendering(this.model)}catch(i){this.showError(i)}}))}setMode(i){this._mode=i,this._mode===Z.Eraser?this.wrapperHTML.classList.add("erasing"):(document.body.style.cursor="initial",this.wrapperHTML.classList.remove("erasing"))}undo(){return __awaiter(this,void 0,void 0,(function*(){return this.model=yield this.behaviors.undo(),this.model}))}redo(){return __awaiter(this,void 0,void 0,(function*(){return this.model=yield this.behaviors.redo(),this.model}))}clear(){return __awaiter(this,void 0,void 0,(function*(){return this.model=yield this.behaviors.clear(this.model),this.model}))}resize(){return __awaiter(this,void 0,void 0,(function*(){return this.model.height=Math.max(this.wrapperHTML.clientHeight,this.configuration.rendering.minHeight),this.model.width=Math.max(this.wrapperHTML.clientWidth,this.configuration.rendering.minWidth),this.model=yield this.behaviors.resize(this.model),this.model}))}export(i){return __awaiter(this,void 0,void 0,(function*(){return this.model=yield this.behaviors.export(this.model,i),this.events.emitExported(this.model.exports),this.model}))}convert(i){return __awaiter(this,void 0,void 0,(function*(){return this.model=yield this.behaviors.convert(this.model,i.conversionState,i.mimeTypes),this.events.emitConvert(this.model.converts),this.model}))}},i.getAvailableLanguageList=function getAvailableLanguageList(i){var n,s;return __awaiter(this,void 0,void 0,(function*(){if((null===(n=null==i?void 0:i.server)||void 0===n?void 0:n.scheme)&&(null===(s=null==i?void 0:i.server)||void 0===s?void 0:s.host)){const n=i.server;return(yield fetch(`${n.scheme}://${n.host}/api/v4.0/iink/availableLanguageList`)).json()}return Promise.reject("Cannot get languages ! Please check your server configuration!")}))},Object.defineProperty(i,"__esModule",{value:!0})}));
//# sourceMappingURL=iink.min.js.map
